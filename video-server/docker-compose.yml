version: '3'

services:
  # Jitsi Meet web interface
  web:
    image: jitsi/web:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      - ENABLE_AUTH=1
      - ENABLE_GUESTS=1
      - AUTH_TYPE=internal
      - JICOFO_AUTH_USER=focus
      - JVB_AUTH_USER=jvb
      - JIGASI_XMPP_USER=jigasi
      - JIBRI_RECORDER_USER=recorder
      - JIBRI_XMPP_USER=jibri
      - PUBLIC_URL=https://your-domain.com
    volumes:
      - ./config:/config
      - ./transcripts:/transcripts
    networks:
      - jitsi-network

  # XMPP server
  prosody:
    image: jitsi/prosody:latest
    restart: always
    environment:
      - AUTH_TYPE=internal
      - JICOFO_AUTH_USER=focus
      - JVB_AUTH_USER=jvb
      - JIGASI_XMPP_USER=jigasi
      - JIBRI_RECORDER_USER=recorder
      - JIBRI_XMPP_USER=jibri
    volumes:
      - ./prosody:/var/lib/prosody
    networks:
      - jitsi-network

  # Conference focus component
  jicofo:
    image: jitsi/jicofo:latest
    restart: always
    environment:
      - JICOFO_AUTH_USER=focus
    depends_on:
      - prosody
    networks:
      - jitsi-network

  # Video bridge
  jvb:
    image: jitsi/jvb:latest
    restart: always
    ports:
      - "10000:10000/udp"
    environment:
      - JVB_AUTH_USER=jvb
      - JVB_STUN_SERVERS=stun.l.google.com:19302,stun1.l.google.com:19302
      - JVB_PORT=10000
    volumes:
      - ./jvb:/config
    networks:
      - jitsi-network

  # Optional: Recording
  jibri:
    image: jitsi/jibri:latest
    restart: always
    environment:
      - JIBRI_RECORDER_USER=recorder
      - JIBRI_XMPP_USER=jibri
      - JIBRI_LOGS_DIR=/logs
      - JIBRI_RECORDING_DIR=/recordings
    volumes:
      - ./recordings:/recordings
      - ./logs:/logs
    networks:
      - jitsi-network

  # Optional: Live streaming
  jigasi:
    image: jitsi/jigasi:latest
    restart: always
    environment:
      - JIGASI_XMPP_USER=jigasi
      - JIGASI_SIP_URI=test@sip2sip.info
    networks:
      - jitsi-network

  # Optional: Etherpad for collaborative editing
  etherpad:
    image: etherpad/etherpad:latest
    restart: always
    ports:
      - "9001:9001"
    environment:
      - ETHERPAD_TITLE=Jitsi Pad
      - ETHERPAD_PORT=9001
    networks:
      - jitsi-network

networks:
  jitsi-network:
    driver: bridge
