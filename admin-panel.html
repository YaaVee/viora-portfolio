<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VYM - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
            padding: 40px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #00ff9d;
        }
        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #00ff9d, #00b8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }
        .stat-card:hover {
            border-color: #00ff9d;
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #00ff9d;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #b0b0b0;
            font-size: 14px;
        }
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #00ff9d;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #00ff9d;
        }
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #00ff9d, #00b8ff);
            border: none;
            border-radius: 8px;
            color: #0a0a0a;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,255,157,0.2);
        }
        button.secondary {
            background: transparent;
            border: 2px solid #00ff9d;
            color: #00ff9d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 15px 10px;
            color: #00ff9d;
            font-weight: 600;
            border-bottom: 2px solid #00ff9d;
        }
        td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge.active {
            background: rgba(0,255,157,0.2);
            color: #00ff9d;
        }
        .badge.disabled {
            background: rgba(255,68,68,0.2);
            color: #ff4444;
        }
        .api-key {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            color: #00ff9d;
            font-size: 12px;
        }
        .invite-link {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .invite-link input {
            flex: 1;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff9d;
            color: #0a0a0a;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            animation: slideIn 0.3s;
            z-index: 1000;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active {
            background: #00ff9d;
            color: #0a0a0a;
            border-color: #00ff9d;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .action-btn {
            background: transparent;
            border: none;
            color: #b0b0b0;
            padding: 5px 10px;
            font-size: 14px;
        }
        .action-btn:hover {
            color: #00ff9d;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-crown"></i> VYM Admin Dashboard</h1>
            <button onclick="logout()" class="secondary">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Login Form (initially visible) -->
        <div id="loginForm" class="card" style="max-width: 400px; margin: 50px auto;">
            <div class="card-title">
                <i class="fas fa-lock"></i> Admin Login
            </div>
            <input type="text" id="adminUsername" placeholder="Username" value="admin">
            <input type="password" id="adminPassword" placeholder="Password" style="margin: 15px 0;">
            <button onclick="adminLogin()" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </div>

        <!-- Admin Dashboard (hidden initially) -->
        <div id="adminDashboard" style="display: none;">
            <!-- Stats Overview -->
            <div class="stats-grid" id="statsOverview">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">Active Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalQueries">-</div>
                    <div class="stat-label">Total Queries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="quotaUsed">-</div>
                    <div class="stat-label">Quota Used %</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('users')">üë• Users</div>
                <div class="tab" onclick="switchTab('invites')">üéüÔ∏è Invites</div>
                <div class="tab" onclick="switchTab('create')">‚ú® Create User</div>
                <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-users"></i> User Management
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Quota Used</th>
                                    <th>Status</th>
                                    <th>API Key</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userList">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invites Tab (Method 3) -->
            <div id="invitesTab" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-ticket-alt"></i> Invite System
                    </div>
                    
                    <!-- Generate Invite -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #00ff9d; margin-bottom: 15px;">Generate New Invite</h3>
                        <div class="form-grid">
                            <input type="number" id="inviteQuota" placeholder="Quota (e.g., 500)" value="500">
                            <input type="number" id="inviteDays" placeholder="Valid for (days)" value="7">
                            <select id="inviteRole">
                                <option value="user">Regular User</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button onclick="generateInvite()">
                                <i class="fas fa-gift"></i> Generate Invite
                            </button>
                        </div>
                        
                        <!-- Generated Invite Display -->
                        <div id="generatedInvite" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,255,157,0.1); border-radius: 10px;">
                            <h4 style="color: #00ff9d; margin-bottom: 10px;">üéâ Invite Generated!</h4>
                            <div class="invite-link">
                                <input type="text" id="inviteLink" readonly>
                                <button class="secondary" onclick="copyInviteLink()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p style="color: #b0b0b0; margin-top: 10px; font-size: 12px;">
                                Share this link with anyone you want to give access. They can create their own account.
                            </p>
                        </div>
                    </div>

                    <!-- Active Invites -->
                    <div>
                        <h3 style="color: #00ff9d; margin-bottom: 15px;">Active Invites</h3>
                        <table id="invitesTable">
                            <thead>
                                <tr>
                                    <th>Invite Code</th>
                                    <th>Quota</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inviteList">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Create User Tab -->
            <div id="createTab" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-user-plus"></i> Create New User
                    </div>
                    <div class="form-grid">
                        <input type="text" id="newUsername" placeholder="Username">
                        <input type="email" id="newEmail" placeholder="Email">
                        <input type="password" id="newPassword" placeholder="Password">
                        <input type="number" id="newQuota" placeholder="Monthly Quota" value="1000">
                        <select id="newRole">
                            <option value="user">Regular User</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button onclick="createUser()">
                            <i class="fas fa-user-plus"></i> Create User
                        </button>
                    </div>
                    <div id="createResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-cog"></i> System Settings
                    </div>
                    <div class="form-grid">
                        <div>
                            <label style="color: #b0b0b0;">Default User Quota</label>
                            <input type="number" id="defaultQuota" value="1000">
                        </div>
                        <div>
                            <label style="color: #b0b0b0;">Rate Limit (per hour)</label>
                            <input type="number" id="rateLimit" value="50">
                        </div>
                        <div>
                            <label style="color: #b0b0b0;">Allow Registration</label>
                            <select id="allowRegistration">
                                <option value="true">Yes (with invite)</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <button onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let adminToken = localStorage.getItem('adminToken');
        let refreshInterval;

        // Check if already logged in
        if (adminToken) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadDashboard();
        }

        // Admin Login
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    adminToken = data.accessToken;
                    localStorage.setItem('adminToken', adminToken);
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadDashboard();
                    startRefreshTimer();
                    showToast('Login successful!');
                } else {
                    showToast('Login failed: ' + (data.error || 'Invalid credentials'), 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // Load Dashboard Data
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.status === 401) {
                    // Token expired, try refresh
                    const refreshed = await refreshToken();
                    if (refreshed) {
                        return loadDashboard();
                    } else {
                        logout();
                        return;
                    }
                }

                const data = await response.json();
                updateStats(data);
                updateUsersTable(data.users);
                loadInvites();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Update Stats
        function updateStats(data) {
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('activeUsers').textContent = data.activeUsers || 0;
            document.getElementById('totalQueries').textContent = data.totalUsed || 0;
            const percentUsed = data.totalUsers ? Math.round((data.totalUsed / data.totalQuota) * 100) : 0;
            document.getElementById('quotaUsed').textContent = percentUsed + '%';
        }

        // Update Users Table
        function updateUsersTable(users) {
            const tbody = document.getElementById('userList');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'active' : ''}">${user.role}</span></td>
                    <td>${user.used}/${user.quota}</td>
                    <td><span class="badge ${user.active ? 'active' : 'disabled'}">${user.active ? 'Active' : 'Disabled'}</span></td>
                    <td><span class="api-key">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> <button class="action-btn" onclick="showApiKey('${user.id}')"><i class="fas fa-eye"></i></button></td>
                    <td>
                        <button class="action-btn" onclick="toggleUserStatus('${user.id}', ${!user.active})">
                            <i class="fas fa-${user.active ? 'ban' : 'check-circle'}"></i>
                        </button>
                        <button class="action-btn" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ============================================
        // METHOD 3: INVITE SYSTEM
        // ============================================

        // Generate Invite Link
        async function generateInvite() {
            const quota = document.getElementById('inviteQuota').value;
            const days = document.getElementById('inviteDays').value;
            const role = document.getElementById('inviteRole').value;

            try {
                const response = await fetch(`${API_URL}/admin/invite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ quota: parseInt(quota), expiresIn: parseInt(days), role })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('generatedInvite').style.display = 'block';
                    document.getElementById('inviteLink').value = data.inviteLink;
                    showToast('Invite generated! Share the link with your user.');
                    loadInvites(); // Refresh invites list
                } else {
                    showToast('Failed to generate invite', 'error');
                }
            } catch (error) {
                showToast('Error generating invite', 'error');
            }
        }

        // Load Active Invites
        async function loadInvites() {
            try {
                const response = await fetch(`${API_URL}/admin/invites`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                const data = await response.json();
                updateInvitesTable(data.invites);
            } catch (error) {
                console.error('Error loading invites:', error);
            }
        }

        // Update Invites Table
        function updateInvitesTable(invites) {
            const tbody = document.getElementById('inviteList');
            if (!invites || invites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No active invites</td></tr>';
                return;
            }

            tbody.innerHTML = invites.map(invite => `
                <tr>
                    <td><span class="api-key">${invite.code}</span></td>
                    <td>${invite.quota}</td>
                    <td>${new Date(invite.expiresAt).toLocaleDateString()}</td>
                    <td><span class="badge ${invite.used ? 'disabled' : 'active'}">${invite.used ? 'Used' : 'Active'}</span></td>
                    <td>
                        <button class="action-btn" onclick="copyInviteCode('${invite.code}')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="action-btn" onclick="revokeInvite('${invite.code}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Copy Invite Link
        function copyInviteLink() {
            const link = document.getElementById('inviteLink');
            link.select();
            document.execCommand('copy');
            showToast('Invite link copied to clipboard!');
        }

        // Copy Invite Code
        function copyInviteCode(code) {
            navigator.clipboard.writeText(code);
            showToast('Invite code copied!');
        }

        // Revoke Invite
        async function revokeInvite(code) {
            if (!confirm('Revoke this invite?')) return;

            try {
                const response = await fetch(`${API_URL}/admin/invite/${code}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    showToast('Invite revoked');
                    loadInvites();
                }
            } catch (error) {
                showToast('Error revoking invite', 'error');
            }
        }

        // ============================================
        // USER MANAGEMENT
        // ============================================

        // Create User (Method 2)
        async function createUser() {
            const user = {
                username: document.getElementById('newUsername').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value,
                quota: parseInt(document.getElementById('newQuota').value),
                role: document.getElementById('newRole').value
            };

            try {
                const response = await fetch(`${API_URL}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(user)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('createResult').innerHTML = `
                        <div style="padding: 15px; background: rgba(0,255,157,0.1); border-radius: 8px;">
                            <p style="color: #00ff9d;">‚úÖ User created successfully!</p>
                            <p><strong>API Key:</strong> <span class="api-key">${data.apiKey}</span></p>
                            <button class="secondary" onclick="copyText('${data.apiKey}')">
                                <i class="fas fa-copy"></i> Copy API Key
                            </button>
                        </div>
                    `;
                    loadDashboard();
                } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error creating user', 'error');
            }
        }

        // Toggle User Status
        async function toggleUserStatus(userId, enable) {
            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/${enable ? 'enable' : 'disable'}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    showToast(`User ${enable ? 'enabled' : 'disabled'}`);
                    loadDashboard();
                }
            } catch (error) {
                showToast('Error updating user', 'error');
            }
        }

        // Delete User
        async function deleteUser(userId) {
            if (!confirm('Delete this user? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    showToast('User deleted');
                    loadDashboard();
                }
            } catch (error) {
                showToast('Error deleting user', 'error');
            }
        }

        // Show API Key
        async function showApiKey(userId) {
            try {
                const response = await fetch(`${API_URL}/admin/users/${userId}/api-key`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();
                prompt('API Key:', data.apiKey);
            } catch (error) {
                showToast('Error fetching API key', 'error');
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tab === 'users' ? 1 : tab === 'invites' ? 2 : tab === 'create' ? 3 : 4})`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#00ff9d' : '#ff4444';
            toast.style.color = type === 'success' ? '#0a0a0a' : 'white';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // Token Refresh
        async function refreshToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) return false;

            try {
                const response = await fetch(`${API_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminToken = data.accessToken;
                    localStorage.setItem('adminToken', adminToken);
                    if (data.refreshToken) {
                        localStorage.setItem('refreshToken', data.refreshToken);
                    }
                    return true;
                }
            } catch (error) {
                console.error('Token refresh failed');
            }
            return false;
        }

        function startRefreshTimer() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(async () => {
                await refreshToken();
            }, 30 * 60 * 1000); // Every 30 minutes
        }

        // Load dashboard every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
